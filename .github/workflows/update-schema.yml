name: update provider schema

on:
  push:
    branches:
      - main
    paths:
      - 'internal/**'
      - 'pkg/**'
      - 'go.mod'
      - 'go.sum'
  pull_request:
    paths:
      - 'internal/**'
      - 'pkg/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  update-schema:
    name: update provider schema
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
        with:
          go-version-file: go.mod
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2

      - name: build provider
        run: go build .

      - name: update schema and generate template
        run: go run scripts/generate_issue_template.go --update-schema

      - name: check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Schema changes detected"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No schema changes needed"
          fi

      - name: commit changes (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check-changes.outputs.has-changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add provider_schema.json .github/ISSUE_TEMPLATE/3-bug-report-enhanced.yml
          git diff --cached --quiet || git commit -m "chore: update provider schema and issue template"
          git push

      - name: post schema update comment (pull request)
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.has-changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ **Schema Update Required**

              Your changes require a provider schema update. Please run the following commands and push the changes:

              \`\`\`bash
              # Update the schema
              go run scripts/generate_issue_template.go --update-schema

              # Commit the changes
              git add provider_schema.json .github/ISSUE_TEMPLATE/3-bug-report-enhanced.yml
              git commit -m "chore: update provider schema and issue template"
              git push
              \`\`\`

              This will update:
              - \`provider_schema.json\` - The provider schema
              - \`.github/ISSUE_TEMPLATE/3-bug-report-enhanced.yml\` - The issue template

              _This comment was automatically generated by the update-schema workflow._`
            })

      - name: post no changes comment (pull request)
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.has-changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **No Schema Update Required**

              Your changes don't require any provider schema updates. Good to go!

              _This comment was automatically generated by the update-schema workflow._`
            })
