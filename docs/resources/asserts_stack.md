---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "grafana_asserts_stack Resource - terraform-provider-grafana"
subcategory: "Knowledge Graph"
description: |-
  Manages the Asserts Stack configuration.
  This resource configures the Asserts stack with the required API tokens for integration
  with Grafana Cloud services. It performs the full onboarding flow:
  Provisions API tokensConfigures datasets (auto-detected or manually specified)Enables the stack
  By default, datasets are auto-configured based on detected metrics. To manually configure
  datasets (e.g., when using non-standard label names), use the dataset block.
  The cloud_access_policy_token is used internally for GCom API access, Mimir metrics
  authentication, and assertion detector webhook authentication. Create a Cloud Access Policy
  with the following scopes: stacks:read, metrics:read, metrics:write.
  The grafana_token is a Grafana Service Account token used for installing dashboards
  and Grafana Managed Alerts.
---

# grafana_asserts_stack (Resource)

Manages the Asserts Stack configuration.

This resource configures the Asserts stack with the required API tokens for integration
with Grafana Cloud services. It performs the full onboarding flow:
1. Provisions API tokens
2. Configures datasets (auto-detected or manually specified)
3. Enables the stack

By default, datasets are auto-configured based on detected metrics. To manually configure 
datasets (e.g., when using non-standard label names), use the `dataset` block.

The `cloud_access_policy_token` is used internally for GCom API access, Mimir metrics 
authentication, and assertion detector webhook authentication. Create a Cloud Access Policy 
with the following scopes: `stacks:read`, `metrics:read`, `metrics:write`.

The `grafana_token` is a Grafana Service Account token used for installing dashboards
and Grafana Managed Alerts.

## Example Usage

```terraform
# Example: Asserts Stack with Cloud Access Policy Token
#
# This example shows how to configure the Asserts stack using existing
# Terraform resources to create the required tokens.
#
# The resource performs the full onboarding flow:
# 1. Provisions API tokens
# 2. Auto-configures datasets based on available metrics
# 3. Enables the stack with the configured datasets

# Step 1: Create a Cloud Access Policy with required scopes
resource "grafana_cloud_access_policy" "asserts" {
  name         = "asserts-stack-policy"
  display_name = "Asserts Stack Policy"

  scopes = [
    "stacks:read",   # For GCom API access
    "metrics:read",  # For Mimir metrics access
    "metrics:write", # For Mimir metrics access
  ]

  realm {
    type       = "stack"
    identifier = var.stack_id
  }
}

# Step 2: Create a token from the Cloud Access Policy
resource "grafana_cloud_access_policy_token" "asserts" {
  name             = "asserts-stack-token"
  access_policy_id = grafana_cloud_access_policy.asserts.policy_id
}

# Step 3: Create a Grafana Service Account for dashboards and Grafana Managed Alerts
# Required permissions: dashboards:create/write/read, folders:create/write/read/delete,
# datasources:read/query, alert.provisioning:write, alert.notifications.provisioning:write,
# alert.notifications:write, alert.rules:read/create/delete
resource "grafana_cloud_stack_service_account" "asserts" {
  stack_slug  = var.stack_slug
  name        = "asserts-managed-alerts-sa"
  role        = "Admin"
  is_disabled = false
}

resource "grafana_cloud_stack_service_account_token" "asserts" {
  stack_slug         = var.stack_slug
  service_account_id = grafana_cloud_stack_service_account.asserts.id
  name               = "asserts-managed-alerts-token"
}

# Step 4: Configure the Asserts Stack (auto-detect datasets)
resource "grafana_asserts_stack" "main" {
  # Required: Cloud Access Policy token for GCom, Mimir, and assertion detector
  cloud_access_policy_token = grafana_cloud_access_policy_token.asserts.token

  # Grafana Service Account token for dashboards and Grafana Managed Alerts
  grafana_token = grafana_cloud_stack_service_account_token.asserts.key
}

# Alternative: Configure the Asserts Stack with manual dataset configuration.
# Use this when your metrics use non-standard labels (e.g., a custom environment label).
resource "grafana_asserts_stack" "custom" {
  cloud_access_policy_token = grafana_cloud_access_policy_token.asserts.token
  grafana_token             = grafana_cloud_stack_service_account_token.asserts.key

  # Available dataset types: kubernetes, otel (App O11y), prometheus, aws
  # Note: "kubernetes" requires K8s Monitoring and "otel" requires App O11y to be enabled.
  dataset {
    type = "kubernetes"

    filter_group {
      env_label  = "deployment_environment"
      site_label = "cluster"

      env_label_values  = ["production", "staging"]
      site_label_values = ["us-east-1", "eu-west-1"]
    }
  }

  dataset {
    type = "prometheus"

    filter_group {
      env_label = "environment"
      env_name  = "prod"

      filter {
        name     = "region"
        operator = "=~"
        values   = ["us-.*", "eu-.*"]
      }
    }
  }
}

# Variables
variable "stack_id" {
  description = "The Grafana Cloud stack ID"
  type        = string
}

variable "stack_slug" {
  description = "The Grafana Cloud stack slug"
  type        = string
}

# Outputs
output "stack_enabled" {
  value       = grafana_asserts_stack.main.enabled
  description = "Whether the Asserts stack is enabled"
}

output "stack_status" {
  value       = grafana_asserts_stack.main.status
  description = "Current onboarding status of the stack"
}

output "stack_version" {
  value       = grafana_asserts_stack.main.version
  description = "Configuration version number"
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `cloud_access_policy_token` (String, Sensitive) A Grafana Cloud Access Policy token with the following scopes: `stacks:read`, `metrics:read`, `metrics:write`. This token is used for GCom API access, Mimir authentication, and assertion detector webhook authentication.

### Optional

- `dataset` (Block List) Manual dataset configuration. When specified, datasets are configured manually instead of using auto-detection. Use this when your metrics use non-standard label names (e.g., a custom environment label). (see [below for nested schema](#nestedblock--dataset))
- `grafana_token` (String, Sensitive) A Grafana Service Account token for installing dashboards and Grafana Managed Alerts. Required permissions: `dashboards:create`, `dashboards:write`, `dashboards:read`, `folders:create`, `folders:write`, `folders:read`, `folders:delete`, `datasources:read`, `datasources:query`, `alert.provisioning:write`, `alert.notifications.provisioning:write`, `alert.notifications:write`, `alert.rules:read`, `alert.rules:create`, `alert.rules:delete`. Create using `grafana_cloud_stack_service_account_token` resource.
- `timeouts` (Block, Optional) (see [below for nested schema](#nestedblock--timeouts))

### Read-Only

- `enabled` (Boolean) Whether the stack is currently enabled.
- `id` (String) The ID of this resource.
- `status` (String) Current onboarding status of the stack.
- `version` (Number) Configuration version number.

<a id="nestedblock--dataset"></a>
### Nested Schema for `dataset`

Required:

- `type` (String) The dataset type. Available types: `kubernetes`, `otel` (App O11y), `prometheus`, `aws`. Note: `kubernetes` requires K8s Monitoring to be enabled, and `otel` requires Application Observability to be enabled on the stack.

Optional:

- `disabled_vendors` (List of String) List of vendors to disable for this dataset.
- `filter_group` (Block List) Filter groups for this dataset. Use when you need custom label mappings. (see [below for nested schema](#nestedblock--dataset--filter_group))

<a id="nestedblock--dataset--filter_group"></a>
### Nested Schema for `dataset.filter_group`

Optional:

- `env_label` (String) The metric label name used for environment (e.g., `env`, `environment`, `deployment_environment`). Defaults to standard labels if not set.
- `env_label_values` (List of String) Specific values of the environment label to match.
- `env_name` (String) A friendly name for the environment.
- `filter` (Block List) Additional metric filters. (see [below for nested schema](#nestedblock--dataset--filter_group--filter))
- `site_label` (String) The metric label name used for site/cluster.
- `site_label_values` (List of String) Specific values of the site label to match.

<a id="nestedblock--dataset--filter_group--filter"></a>
### Nested Schema for `dataset.filter_group.filter`

Required:

- `name` (String) The label name to filter on.
- `operator` (String) The filter operator (e.g., `=`, `!=`, `=~`, `!~`).
- `values` (List of String) The values to match.




<a id="nestedblock--timeouts"></a>
### Nested Schema for `timeouts`

Optional:

- `create` (String)
- `delete` (String)
- `read` (String)
- `update` (String)

## Import

Import is supported using the following syntax:

```shell
terraform import grafana_asserts_stack.name "{{ id }}"
```
